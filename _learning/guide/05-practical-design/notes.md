# 실전 프롬프트 설계 - scrape-hub 적용

## scrape-hub 과제 분석

### 핵심 과제
1. **NER 오매칭 필터링**: Gazetteer false positive 제거
2. **Entity Linking**: CUI 매핑 정확도 향상
3. **관계 추출**: TREATS 관계 검증 (Drug → Disease)

### 실제 오류 사례 (260108 리포트)
```
입술을 제외한 두경부의 1차 편평세포암종
→ "입술" → T20 (화상) ❌
→ 실제: 해부학적 위치 설명일 뿐

무증상 또는 경미한 증상의 전이성 거세저항성 전립선암
→ "무증상" → O98 (임신합병증) ❌
→ 실제: 증상의 부재를 설명
```

## 학습한 기법 적용

### 1. Few-Shot (v2)
- 각 엔티티 타입별 유효/무효 예시 제공
- 경계 케이스 커버

### 2. Chain-of-Thought (v3)
- 독립성, 맥락, 형태 단계별 분석
- 판단 근거 제공으로 디버깅 용이

### 3. LLM-as-a-Judge (v4)
- 검증 결과 품질 평가
- 자동 품질 모니터링

## 실전 프롬프트 설계 원칙

### 1. 명확한 태스크 정의
```
❌ "이 텍스트를 분석하세요"
✅ "Gazetteer가 매칭한 '{entity}'가 원본 텍스트에서
    실제 {entity_type}을 지칭하는지 판단하세요"
```

### 2. 도메인 지식 주입
```yaml
# 의료 도메인 특화 지식
- KCD 코드 체계 이해
- 효능효과 문서 구조
- 부분 문자열 매칭 오류 패턴
```

### 3. 출력 형식 일관성
```yaml
# 후처리 용이한 형식
- 간단한 경우: "유효" / "무효"
- CoT: "추론: ... 판정: ..."
- Judge: JSON 구조
```

### 4. 에러 케이스 커버
```yaml
# 발견된 오류 패턴
- 부분 문자열: "입술" in "입술을 제외한"
- 동음이의어: "무증상" (증상부재 vs HIV무증상감염)
- 문맥 무관: "MRI실" (장소 vs 검사)
```

## 최종 프롬프트 체계

### Phase 1: 1차 검증 (v2/v3)
```
입력: text, entity, entity_type
출력: 유효/무효 (+ 이유)
용도: 대량 배치 처리
```

### Phase 2: 품질 평가 (v4)
```
입력: v3 출력 + 정답
출력: 품질 점수 + 피드백
용도: 샘플링 기반 QA
```

### Phase 3: 관계 검증 (신규)
```
입력: drug, disease, 효능효과 텍스트
출력: TREATS 관계 유효성
용도: Knowledge Graph 품질 보증
```

## 다음 단계

1. **API 테스트**: .env에 키 넣고 실제 실행
2. **비교 실험**: v2 vs v3 정확도/비용 비교
3. **프로덕션 적용**: scrape-hub에 통합
